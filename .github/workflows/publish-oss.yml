# **what?**
# Orchestrates the OSS publishing process: bumps version, generates changelog, runs tests, and publishes to PyPI.

# **why?**
# Automates the complete release process for open-source adapter packages, ensuring all steps are completed correctly.

# **when?**
# This workflow can be manually triggered via workflow_dispatch to publish packages to PyPI (test or production).

name: "Publish OSS"
run-name: "Publish OSS - ${{ github.actor }} - package:${{ inputs.package }} deploy-to:${{ inputs.deploy-to }} branch:${{ inputs.branch }} version:${{ inputs.version }} skip-unit-tests:${{ inputs.skip-unit-tests }} skip-integration-tests:${{ inputs.skip-integration-tests }}"

on:
    workflow_dispatch:
        inputs:
            package:
                description: "Choose the package to publish"
                type: choice
                options:
                    - "dbt-adapters"
                    - "dbt-tests-adapter"
                    - "dbt-athena"
                    - "dbt-bigquery"
                    - "dbt-postgres"
                    - "dbt-redshift"
                    - "dbt-snowflake"
                    - "dbt-spark"
            deploy-to:
                description: "Choose whether to publish to test or prod"
                type: choice
                options: ["prod", "test"]
            branch:
                description: "Choose the branch to publish from"
                type: string
                # generally all OSS post-prod releases should be off of stable
                default: "stable"
            version:
                description: "Choose the version to bump to (e.g. 1.2.3rc1, patch, release) or leave empty"
                type: string
                default: ""
            target:
                description: "Choose where to publish"
                type: choice
                options:
                    - "pypi"
                    - "github"
                    - "docker"
                    - "all"
            skip-unit-tests:
                description: "Skip running unit tests"
                type: boolean
                default: false
            skip-integration-tests:
                description: "Skip running integration tests"
                type: boolean
                default: false

# don't publish to the same target in parallel
concurrency:
    group: Publish_OSS-${{ inputs.package }}-${{ inputs.deploy-to }}
    cancel-in-progress: true

permissions:
    contents: write
    id-token: write
    packages: write

jobs:
    work-branch:
        runs-on: ${{ vars.DEFAULT_RUNNER }}
        outputs:
            name: ${{ steps.branch.outputs.name }}
        steps:
            - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # actions/checkout@v4
              with:
                  ref: ${{ inputs.branch }}
            - id: branch
              run: |
                  name="publish-oss/${{ inputs.package }}/$GITHUB_RUN_ID"
                  echo "name=$name" >> $GITHUB_OUTPUT
            - run: |
                  git checkout -b ${{ steps.branch.outputs.name }}
                  git push -u origin ${{ steps.branch.outputs.name }}

    bump-version:
        needs: work-branch
        uses: ./.github/workflows/_bump-version.yml
        with:
            package: ${{ inputs.package }}
            branch: ${{ needs.work-branch.outputs.name }}
            version: ${{ inputs.version }}
        secrets: inherit

    generate-changelog:
        if: ${{ !failure() && !cancelled() }}
        needs:
            - work-branch
            - bump-version # bump-version may be a no-op, but the changelog should be generated for the latest version
        uses: ./.github/workflows/_generate-changelog.yml
        with:
            package: ${{ inputs.package }}
            branch: ${{ needs.work-branch.outputs.name }}
        secrets: inherit

    unit-tests:
        if: |
            !failure() && !cancelled() &&
            inputs.skip-unit-tests == false &&
            !contains(fromJSON('["dbt-tests-adapter"]'), inputs.package)
        needs:
            - work-branch
            - bump-version # bump-version may be a no-op, but tests need to run with the latest version
        uses: ./.github/workflows/_unit-tests.yml
        with:
            package: ${{ inputs.package }}
            branch: ${{ needs.work-branch.outputs.name }}
            hatch-env: "cd"

    integration-tests:
        if: |
            !failure() && !cancelled() &&
            inputs.skip-integration-tests == false &&
            !contains(fromJSON('["dbt-adapters", "dbt-tests-adapter"]'), inputs.package)
        needs:
            - work-branch
            - bump-version # bump-version may be a no-op, but tests need to run with the latest version
        uses: ./.github/workflows/_integration-tests.yml
        with:
            packages: ${{ toJSON(inputs.package) }}
            branch: ${{ needs.work-branch.outputs.name }}
            hatch-env: "cd"
        secrets: inherit

    merge-changes:
        if: |
            !failure() && !cancelled()
        needs:
            - work-branch
            - bump-version
            - generate-changelog
            - unit-tests
            - integration-tests
        runs-on: ${{ vars.DEFAULT_RUNNER }}
        steps:
            - name: "[PROD] Merge work branch to target branch"
              # merge changes before publishing to prod because we lock trusted publishing to main
              uses: everlytic/branch-merge@c4a244dc23143f824ae6c022a10732566cb8e973 # everlytic/branch-merge@1.1.5
              if: inputs.deploy-to == 'prod'
              with:
                  source_ref: ${{ needs.work-branch.outputs.name }}
                  target_branch: ${{ inputs.branch }}
                  github_token: ${{ secrets.FISHTOWN_BOT_PAT }}
                  commit_message_template: "[Automated] Publish ${{ inputs.package }}==${{ needs.bump-version.outputs.final }}"

    publish-pypi:
        if: always() && !failure() && contains(fromJSON('["pypi", "all"]'), inputs.target)
        needs:
            - work-branch
            - merge-changes
        uses: ./.github/workflows/_publish-pypi.yml
        with:
            package: ${{ inputs.package }}
            deploy-to: ${{ inputs.deploy-to }}
            branch: ${{ inputs.deploy-to == 'prod' && inputs.branch || needs.work-branch.outputs.name }}
        secrets: inherit

    publish-pypi-athena-community:
        if: always() && !failure() && contains(fromJSON('["pypi", "all"]'), inputs.target) && inputs.package == 'dbt-athena'
        needs:
            - work-branch
            - merge-changes
            - bump-version
        runs-on: ${{ vars.DEFAULT_RUNNER }}
        environment:
            name: ${{ inputs.deploy-to }}
            url: ${{ vars.PYPI_PROJECT_URL }}/dbt-athena-community
        permissions:
            id-token: write
        steps:
            - name: "[PROD] Checkout target branch"
              uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # actions/checkout@v4
              if: inputs.deploy-to == 'prod'
              with:
                  ref: ${{ inputs.branch }}

            - name: "[TEST] Checkout work branch"
              uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # actions/checkout@v4
              if: inputs.deploy-to != 'prod'
              with:
                  ref: ${{ needs.work-branch.outputs.name }}

            - name: "Set up Python"
              uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # actions/setup-python@v5
              with:
                  python-version: ${{ vars.DEFAULT_PYTHON_VERSION }}

            - name: "Install hatch"
              uses: pypa/hatch@257e27e51a6a5616ed08a39a408a21c35c9931bc # pypa/hatch@install

            - name: "Build dbt-athena-community"
              run: hatch build && hatch run build:check-all
              working-directory: ./dbt-athena-community

            - name: "Publish dbt-athena-community to PyPI"
              uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e # pypa/gh-action-pypi-publish@release/v1
              with:
                  repository-url: ${{ vars.PYPI_REPOSITORY_URL }}
                  packages-dir: ./dbt-athena-community/dist/

            - name: "Get package version"
              id: version
              run: echo "version=$(hatch version)" >> $GITHUB_OUTPUT
              working-directory: ./dbt-athena-community

            - name: "Verify dbt-athena-community on PyPI"
              uses: nick-fields/retry@ce71cc2ab81d554ebbe88c79ab5975992d79ba08 # nick-fields/retry@v3
              with:
                  timeout_seconds: 10
                  retry_wait_seconds: 10
                  max_attempts: 15 # 5 minutes: (10s timeout + 10s delay) * 15 attempts
                  command: wget ${{ vars.PYPI_PROJECT_URL }}/dbt-athena-community/${{ steps.version.outputs.version }}

    publish-github:
        if: always() && !failure() && contains(fromJSON('["github", "all"]'), inputs.target)
        needs: merge-changes
        uses: ./.github/workflows/_publish-github.yml
        with:
            package: ${{ inputs.package }}
            deploy-to: ${{ inputs.deploy-to }}
            branch: ${{ inputs.branch }}
        secrets: inherit

    publish-docker:
        if: always() && !failure() && contains(fromJSON('["docker", "all"]'), inputs.target)
        needs:
            - merge-changes
            - bump-version
        uses: ./.github/workflows/_publish-docker.yml
        with:
            package: ${{ inputs.package }}
            deploy-to: ${{ inputs.deploy-to }}
            version: ${{ needs.bump-version.outputs.final }}
        secrets: inherit

    clean-up:
        if: ${{ !cancelled() }}
        needs:
            - work-branch
            - publish-pypi
            - publish-pypi-athena-community
            - publish-github
            - publish-docker
        runs-on: ${{ vars.DEFAULT_RUNNER }}
        steps:
            - name: "Checkout ${{ inputs.branch }}"
              uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # actions/checkout@v4
              with:
                  ref: ${{ inputs.branch }}

            - name: "Delete work branch"
              # we should delete this regardless of whether we merged it to avoid building up stale release branches
              run: git push origin -d ${{ needs.work-branch.outputs.name }}
              continue-on-error: true
