name: "Changelog entry check"

on:
    workflow_call:
        inputs:
            package:
                description: "Choose the package to test"
                type: string
                default: "dbt-adapters"
            pull-request:
                description: "The PR number"
                type: string
                required: true
    workflow_dispatch:
        inputs:
            package:
                description: "Choose the package to test"
                type: string
                default: "dbt-adapters"
            pull-request:
                description: "The PR number"
                type: string
                required: true

permissions:
    contents: read
    pull-requests: write

jobs:
    package:
        uses: ./.github/workflows/_package-directory.yml
        with:
            package: ${{ inputs.package }}

    changelog-check:
        needs: package
        if: ${{ !contains(github.event.pull_request.labels.*.name, 'Skip Changelog') }}
        outputs:
            exists: ${{ steps.changelog.outputs.exists }}
        runs-on: ubuntu-latest
        steps:
        -   id: changelog
            uses: dorny/paths-filter@v3
            with:
                token: ${{ secrets.GITHUB_TOKEN }}
                filters: |
                    exists:
                    -   added|modified: '${{ needs.package.outputs.directory }}/.changes/unreleased/**.yaml'

    comment:
        needs: changelog-check
        if: needs.changelog-check.outputs.exists == false
        runs-on: ubuntu-latest
        env:
            AUTHOR: "github-actions[bot]"
            COMMENT: >-
                Thank you for your pull request! We could not find a changelog entry for this change in the ${{ inputs.package }} package.
                For details on how to document a change, see the [Contributing Guide](https://github.com/dbt-labs/dbt-adapters/blob/main/CONTRIBUTING.md).
        steps:
        -   id: comment
            uses: peter-evans/find-comment@v3
            with:
                issue-number: ${{ inputs.pull-request }}
                comment-author: ${{ env.AUTHOR }}
                body-includes: ${{ env.COMMENT }}
        -   if: steps.comment.outputs.comment-body == ''
            run: gh issue comment ${{ inputs.pull-request }} --repo ${{ github.repository }} --body "${{ env.COMMENT }}"
            shell: bash
            env:
                GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        -   uses: actions/github-script@v7
            with:
                script: core.setFailed('Changelog entry required to merge.')
