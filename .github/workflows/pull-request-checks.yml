name: "Pull request checks"

on:
    pull_request_target:
        types: [opened, reopened, synchronize, labeled, unlabeled]

# only run this once per PR at a time
concurrency:
    group: ${{ github.workflow }}-${{ github.event.number }}
    cancel-in-progress: true

jobs:
    changelog-entry:
        uses: dbt-labs/dbt-adapters/.github/workflows/_changelog-entry-check.yml@main
        with:
            package: "dbt-athena"
            pull-request: ${{ github.event.pull_request.number }}
        secrets: inherit

    code-quality:
        uses: dbt-labs/dbt-adapters/.github/workflows/_code-quality.yml@main
        with:
            branch: ${{ github.event.pull_request.head.ref }}
            repository: ${{ github.event.pull_request.head.repo.full_name }}

    verify-builds:
        uses: dbt-labs/dbt-adapters/.github/workflows/_verify-build.yml@main
        strategy:
            fail-fast: false
            matrix:
                package: ["dbt-athena", "dbt-athena-community"]
                os: [ubuntu-22.04]
                python-version: ["3.9", "3.10", "3.11", "3.12"]
        with:
            package: ${{ matrix.package }}
            branch: ${{ github.event.pull_request.head.ref }}
            repository: ${{ github.event.pull_request.head.repo.full_name }}
            os: ${{ matrix.os }}
            python-version: ${{ matrix.python-version }}

    unit-tests:
        uses: dbt-labs/dbt-adapters/.github/workflows/_unit-tests.yml@main
        strategy:
            fail-fast: false
            matrix:
                package: ["dbt-athena", "dbt-athena-community"]
                os: [ubuntu-22.04]
                python-version: ["3.9", "3.10", "3.11", "3.12"]
        with:
            package: ${{ matrix.package }}
            branch: ${{ github.event.pull_request.head.ref }}
            repository: ${{ github.event.pull_request.head.repo.full_name }}
            os: ${{ matrix.os }}
            python-version: ${{ matrix.python-version }}

    integration-tests:
        name: "Integration tests"
        strategy:
            fail-fast: false
            matrix:
                package: ["dbt-athena", "dbt-athena-community"]
                python-version: ["3.9", "3.10", "3.11", "3.12"]
        runs-on: ubuntu-22.04
        env:
            DBT_TEST_ATHENA_S3_STAGING_DIR: ${{ vars.DBT_TEST_ATHENA_S3_BUCKET }}/staging/
            DBT_TEST_ATHENA_S3_TMP_TABLE_DIR: ${{ vars.DBT_TEST_ATHENA_S3_BUCKET }}/tmp_tables/
            DBT_TEST_ATHENA_REGION_NAME: ${{ vars.DBT_TEST_ATHENA_REGION_NAME }}
            DBT_TEST_ATHENA_DATABASE: awsdatacatalog
            DBT_TEST_ATHENA_SCHEMA: dbt-tests
            DBT_TEST_ATHENA_WORK_GROUP: athena-dbt-tests
            DBT_TEST_ATHENA_THREADS: 16
            DBT_TEST_ATHENA_POLL_INTERVAL: 0.5
            DBT_TEST_ATHENA_NUM_RETRIES: 3
        steps:
        -   uses: actions/checkout@v4
            with:
                ref: ${{ github.event.pull_request.head.ref }}
                repository: ${{ github.event.pull_request.head.repo.full_name }}
        -   uses: actions/setup-python@v5
            with:
                python-version: ${{ matrix.python-version }}
        -   uses: pypa/hatch@install
        -   uses: aws-actions/configure-aws-credentials@v4
            with:
                role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ secrets.ASSUMABLE_ROLE_NAME }}
                aws-region: ${{ vars.DBT_TEST_ATHENA_REGION_NAME }}
        -   run: hatch run integration-tests
            working-directory: ./${{ matrix.package }}

    # This job does nothing and is only used for branch protection
    results:
        name: "Pull request checks"
        if: always()
        needs: [code-quality, changelog-entry, verify-builds, unit-tests, integration-tests]
        runs-on: ${{ vars.DEFAULT_RUNNER }}
        steps:
        -   uses: re-actors/alls-green@release/v1
            with:
                jobs: ${{ toJSON(needs) }}
