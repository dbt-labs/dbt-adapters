name: "Publish"

on:
    workflow_dispatch:
        inputs:
            package:
                description: "Choose the package to publish"
                type: string
                default: "dbt-adapters"
            deploy-to:
                description: "Choose whether to deploy to test or prod"
                type: environment
                default: "prod"
            branch:
                description: "Choose the branch to publish"
                type: string
                default: "main"
            pypi-internal:
                description: "Publish to internal PyPI"
                type: boolean
                default: true
            pypi-public:
                description: "Publish to PyPI"
                type: boolean
                default: false

# don't attempt to release the same target in parallel
concurrency:
    group: ${{ github.workflow }}-${{ inputs.deploy-to }}
    cancel-in-progress: true

jobs:
    unit-tests:
        uses: ./.github/workflows/_unit-tests.yml
        with:
            package: ${{ inputs.package }}
            branch: ${{ inputs.branch }}

    integration-tests:
        uses: ./.github/workflows/_integration-tests.yml
        with:
            package: ${{ inputs.package }}
            branch: ${{ inputs.branch }}
        secrets: inherit

    generate-changelog:
        uses: ./.github/workflows/_generate-changelog.yml
        with:
            package: ${{ inputs.package }}
            deploy-to: ${{ inputs.deploy-to }}
            branch: ${{ inputs.branch }}
        secrets: inherit

    publish-internal:
        if: ${{ inputs.pypi-internal == true }}
        needs: [unit-tests, integration-tests]
        uses: ./.github/workflows/_publish-internal.yml
        with:
            package: ${{ inputs.package }}
            deploy-to: ${{ inputs.deploy-to }}
            branch: ${{ inputs.branch }}
        secrets: inherit

    publish-pypi:
        if: ${{ inputs.pypi-public == true }}
        needs: [unit-tests, integration-tests]
        uses: ./.github/workflows/_publish-pypi.yml
        with:
            package: ${{ inputs.package }}
            deploy-to: ${{ inputs.deploy-to }}
            branch: ${{ inputs.branch }}
